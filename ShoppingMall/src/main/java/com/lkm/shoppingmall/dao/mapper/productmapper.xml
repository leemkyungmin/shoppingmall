<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.lkm.shoppingmall.dao.productDAO">
	
	<select id="mylist" parameterType="String" resultType="com.lkm.shoppingmall.dto.myproduct">
		SELECT p.PIDX,p.pNAME,p.PDATE,p.DIDX,p.Price,p.PORDER_PRICE,count(r.RIDX) as rCount, NVL(sum(r.RATING),0) as rTotal,TO_CHAR(p.pSumnail) as pSumnail
		FROM PRODUCTS p LEFT OUTER JOIN REVIEW r on p.PIDX = r.PIDX
		WHERE p.DIDX =#{param1}
        group by p.PIDX,p.pNAME,p.PDATE,p.DIDX,p.Price,p.PORDER_PRICE,TO_CHAR(p.pSumnail)
	</select>
	<insert id="insertproduct" parameterType="Map" >
		<selectKey keyProperty="pidx" resultType="int" order="BEFORE">
			SELECT PRODUCTS_SEQ.NEXTVAL as pidx FROM DUAL
		</selectKey>
		INSERT INTO PRODUCTS(PIDX,PNAME,PRICE,PRICE_PER,PDATE,PORDER_PRICE,DIDX,PSUMNAIL)
		VALUES(
			${pidx},
			'${pName}',
			${price},
			'0',
			SYSDATE,
			${order_price},
			${didx},
			'${psumNail}'	
		)
	</insert>
	<insert id="insertproductnotice" parameterType="Map">
		INSERT INTO PRODUCTS_NOTICE(PNIDX,PNIMG,PIDX,PIMG)
		VALUES (
			PRODUCT_NOTICE_SEQ.NEXTVAL,
			'${notice_img}',
			${pidx},
			'${pimg}'
		)
	</insert>
	<insert id="insertproductOption1" parameterType="Map">
		<selectKey keyProperty="poidx" resultType="int" order="BEFORE">
			SELECT PRODUCT_NOTICE_SEQ.nextval as poidx FROM dual
		</selectKey>
		INSERT INTO PRODUCTS_OPTION(POIDX,PONAME,POPRICE)
		VALUES (
			#{poidx},
			'${poname}',
			${avg_price}
		)
	</insert>
	<insert id="insertproductOption2" parameterType="Map">
		INSERT INTO PRODUCTS_OPTION(POIDX,PONAME,POPRICE,PODEPT,POEND)
		VALUES(
			PRODUCT_NOTICE_SEQ.nextval,
			'${op2_name}',
			${op2_price},
			${poidx},
			'Y'
		)
	</insert>
	
	<select id="selectmyProduct" parameterType="com.lkm.shoppingmall.dto.productsDto" resultType="com.lkm.shoppingmall.dto.productsDto">
		SELECT *
		FROM PRODUCTS
		WHERE PIDX = ${pIdx}
	
	</select>
	<select id="selectmyProduct_notice" parameterType="com.lkm.shoppingmall.dto.product_notice" resultType="com.lkm.shoppingmall.dto.product_notice">
		SELECT * 
		FROM PRODUCTS_NOTICE
		WHERE PIDX = ${pIdx}
	</select>
	<select id="selectproduct_options" parameterType="int" resultType="com.lkm.shoppingmall.dto.product_optionDto">
		SELECT a.poname as top_option,b.*
		FROM PRODUCTS_OPTION a inner join products_option b  on a.poidx =b.podept
		where a.podept =0 AND a.pidx = b.pidx AND a.pidx = #{param1}
	</select>
	
</mapper>